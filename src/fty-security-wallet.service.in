[Unit]
Description=fty-security-wallet service
After=network.target malamute.service
Requires=network.target malamute.service
PartOf=bios.target

[Service]
Type=@systemd_service_type@
User=secw-daemon
EnvironmentFile=-@prefix@/share/fty/etc/default/fty
EnvironmentFile=-@prefix@/share/fty/etc/default/fty__%n.conf
EnvironmentFile=-@sysconfdir@/default/fty
EnvironmentFile=-@sysconfdir@/default/fty__%n.conf
# Note: the database interaction here is complicated.
# This service is needed to e.g. seed and serve the SSL certificates
# during first boot long before the database appears, but also has a
# bit of direct database interaction when it is available. So we do
# not want it to fail the startup when/if database is not running,
# but also to know how to access it when it does, for proxyDocuments.
# Note2: Devs said that so far we do not want to restart secw when
# the database appears (which may be relevant also for system boots
# other than the first one - first run to serve the certificate for
# web-servers, then fty-db.target starts, then restart with ability
# to access the database... for some reason, we do not do that now).
EnvironmentFile=-@sysconfdir@/default/bios-db-rw
Environment="prefix=@prefix@"
ExecStart=@prefix@/bin/fty-security-wallet -c @sysconfdir@/@PACKAGE@/fty-security-wallet.cfg

# This service is only active, as far as consumers are concerned,
# after it listens on the Unix socket used to interact with it.
ExecStartPost=/bin/dash -c "while sleep 0.1; do test -S \"@socketSecurityWallet@\" || continue; PIDS=\"`/bin/fuser \"@socketSecurityWallet@\" 2>/dev/null | sed -e 's,^ *,,' -e 's, *$,,'`\" && [ -n \"$PIDS\" ] && { ( for P in $PIDS ; do ls -la /proc/$P/exe ; done | egrep ' /usr/bin/fty-security-wallet$' ) && break ; rePIDS=\"(`echo \"$PIDS\" | sed 's,  *,|,g'`)\" ; ps -ef | grep -v grep | grep -E \"$rePIDS\" && break ; } ; netstat -anp 2>/dev/null | egrep -q '^unix.*LISTEN.* @socketSecurityWallet@$' && break ; done; echo 'Socket is being listened'"

# There is also some time for malamute connection that I could not detect easily
# Perhaps we can query with an MQ client (bmsg?) or even use Type=notify unit
ExecStartPost=/bin/sleep 3

# Last agent out should shut the door cleanly
ExecStopPost=/bin/dash -c "if [ -z \"`/bin/fuser \"@socketSecurityWallet@\" 2>/dev/null | sed -e 's, *,,g'`\" ] ; then rm -f \"@socketSecurityWallet@\" ; fi"

Restart=always

[Install]
WantedBy=bios.target
